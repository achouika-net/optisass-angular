<div class="sales-control-container">
    <div class="header">
        <h1>
            Contrôle des Ventes
            <span class="subtitle">Gestion fiscale et suivi des ventes par période</span>
        </h1>
        <div class="date-range-badge" *ngIf="filterType !== 'ALL'">
            {{ filterType }} :
            <span *ngIf="filterType === 'DAILY'">{{ selectedDate | date:'dd/MM/yyyy' }}</span>
            <span *ngIf="filterType === 'MONTHLY'">{{ availableMonths[selectedMonth-1].label }} {{ selectedYear
                }}</span>
            <span *ngIf="filterType === 'YEARLY'">Année {{ selectedYear }}</span>
            <span *ngIf="filterType === 'CUSTOM'">{{ customStartDate | date:'dd/MM/yyyy' }} - {{ customEndDate |
                date:'dd/MM/yyyy' }}</span>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="summary-cards" style="display: flex; gap: 1.5rem; margin-bottom: 2rem; flex-wrap: wrap;">
        <!-- CA Global Card -->
        <mat-card class="stat-card blue"
            style="flex: 1.5; min-width: 300px; background: #f0f7ff; border-left: 5px solid #007bff; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);">
            <mat-card-content style="padding: 1.25rem;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div class="stat-info">
                        <p class="stat-label"
                            style="margin: 0; color: #64748b; font-size: 0.875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.025em;">
                            Chiffre d'Affaires Global</p>
                        <h2 class="stat-value"
                            style="margin: 0.25rem 0; font-size: 2.25rem; font-weight: 800; color: #1e293b;">{{
                            metrics.totalCA | number:'1.2-2' }} <span
                                style="font-size: 1rem; font-weight: 500;">DH</span></h2>
                    </div>
                    <div class="stat-icon"
                        style="background: #007bff1a; padding: 0.75rem; border-radius: 12px; color: #007bff;">
                        <mat-icon style="width: 32px; height: 32px; font-size: 32px;">account_balance_wallet</mat-icon>
                    </div>
                </div>
                <div
                    style="display: flex; gap: 1rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0; font-size: 0.85rem;">
                    <div style="flex: 1;">
                        <span style="color: #64748b;">Factures:</span>
                        <div style="font-weight: 700; color: #10b981;">+{{ metrics.totalFactures | number:'1.2-2' }}
                        </div>
                    </div>
                    <div style="flex: 1; border-left: 1px solid #e2e8f0; padding-left: 1rem;">
                        <span style="color: #64748b;">BC (Instance):</span>
                        <div style="font-weight: 700; color: #f59e0b;">{{ metrics.totalBC | number:'1.2-2' }}</div>
                    </div>
                    <div style="flex: 1; border-left: 1px solid #e2e8f0; padding-left: 1rem;">
                        <span style="color: #64748b;">Avoirs:</span>
                        <div style="font-weight: 700; color: #ef4444;">-{{ metrics.totalAvoirs | number:'1.2-2' }}</div>
                    </div>
                </div>
            </mat-card-content>
        </mat-card>

        <!-- Cash Flow Card -->
        <mat-card class="stat-card green"
            style="flex: 1; min-width: 250px; background: #f0fdf4; border-left: 5px solid #22c55e;">
            <mat-card-content style="padding: 1.25rem;">
                <div style="display: flex; justify-content: space-between;">
                    <div>
                        <p class="stat-label" style="margin: 0; color: #64748b; font-size: 0.875rem; font-weight: 600;">
                            ENCAISSÉ (PÉRIODE)</p>
                        <h2 class="stat-value"
                            style="margin: 0.5rem 0; font-size: 1.75rem; color: #15803d; font-weight: 700;">{{
                            metrics.totalPaid | number:'1.2-2' }} DH</h2>
                    </div>
                    <mat-icon style="color: #22c55e; font-size: 28px;">payments</mat-icon>
                </div>
                <div style="margin-top: 1rem; padding-top: 0.75rem; border-top: 1px solid #dcfce7; font-size: 0.8rem; color: #166534;"
                    *ngIf="metrics.paymentBreakdown.length > 0">
                    <div style="display: flex; flex-wrap: wrap; gap: 0.75rem;">
                        <div *ngFor="let p of metrics.paymentBreakdown"
                            style="background: #ffffff; padding: 2px 8px; border-radius: 4px; border: 1px solid #dcfce7;">
                            <span style="color: #64748b;">{{ getPaymentLabel(p.methode) }}:</span>
                            <span style="font-weight: 700; margin-left: 4px;">{{ p.total | number:'1.2-2' }}</span>
                        </div>
                    </div>
                </div>
            </mat-card-content>
        </mat-card>

        <!-- Balance Card -->
        <mat-card class="stat-card red"
            style="flex: 1; min-width: 250px; background: #fef2f2; border-left: 5px solid #ef4444;">
            <mat-card-content style="padding: 1.25rem;">
                <div style="display: flex; justify-content: space-between;">
                    <div>
                        <p class="stat-label" style="margin: 0; color: #64748b; font-size: 0.875rem; font-weight: 600;">
                            RESTE À RECOUVRER</p>
                        <h2 class="stat-value"
                            style="margin: 0.5rem 0; font-size: 1.75rem; color: #b91c1c; font-weight: 700;">{{
                            metrics.totalReste | number:'1.2-2' }} DH</h2>
                    </div>
                    <mat-icon style="color: #ef4444; font-size: 28px;">warning</mat-icon>
                </div>
            </mat-card-content>
        </mat-card>
    </div>

    <!-- Advanced Filter Section -->
    <div class="filter-toolbar">
        <div class="period-chips">
            <button mat-stroked-button [color]="filterType === 'ALL' ? 'primary' : ''"
                (click)="setFilterType('ALL')">Toute la période</button>
            <button mat-stroked-button [color]="filterType === 'DAILY' ? 'primary' : ''"
                (click)="setFilterType('DAILY')">Aujourd'hui</button>
            <button mat-stroked-button [color]="filterType === 'MONTHLY' ? 'primary' : ''"
                (click)="setFilterType('MONTHLY')">Par Mois</button>
            <button mat-stroked-button [color]="filterType === 'YEARLY' ? 'primary' : ''"
                (click)="setFilterType('YEARLY')">Annuel</button>
            <button mat-stroked-button [color]="filterType === 'CUSTOM' ? 'primary' : ''"
                (click)="setFilterType('CUSTOM')">Personnalisé</button>
        </div>

        <div class="filter-controls">
            <!-- Dynamic Controls -->
            <ng-container [ngSwitch]="filterType">
                <!-- Daily -->
                <mat-form-field appearance="outline" class="density-compact" *ngSwitchCase="'DAILY'">
                    <mat-label>Date</mat-label>
                    <input matInput [matDatepicker]="dPicker" [(ngModel)]="selectedDate" (dateChange)="onFilterChange()"
                        title="Choisir une date">
                    <mat-datepicker-toggle matSuffix [for]="dPicker"></mat-datepicker-toggle>
                    <mat-datepicker #dPicker></mat-datepicker>
                </mat-form-field>

                <!-- Monthly -->
                <ng-container *ngSwitchCase="'MONTHLY'">
                    <mat-form-field appearance="outline" class="density-compact">
                        <mat-label>Mois</mat-label>
                        <mat-select [(ngModel)]="selectedMonth" (selectionChange)="onFilterChange()"
                            title="Sélectionner le mois">
                            <mat-option *ngFor="let m of availableMonths" [value]="m.value">{{ m.label }}</mat-option>
                        </mat-select>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="density-compact">
                        <mat-label>Année</mat-label>
                        <mat-select [(ngModel)]="selectedYear" (selectionChange)="onFilterChange()"
                            title="Sélectionner l'année">
                            <mat-option *ngFor="let y of availableYears" [value]="y">{{ y }}</mat-option>
                        </mat-select>
                    </mat-form-field>
                </ng-container>

                <!-- Yearly -->
                <mat-form-field appearance="outline" class="density-compact" *ngSwitchCase="'YEARLY'">
                    <mat-label>Année</mat-label>
                    <mat-select [(ngModel)]="selectedYear" (selectionChange)="onFilterChange()"
                        title="Sélectionner l'année">
                        <mat-option *ngFor="let y of availableYears" [value]="y">{{ y }}</mat-option>
                    </mat-select>
                </mat-form-field>

                <!-- Custom -->
                <ng-container *ngSwitchCase="'CUSTOM'">
                    <mat-form-field appearance="outline" class="density-compact">
                        <mat-label>Du</mat-label>
                        <input matInput [matDatepicker]="sPicker" [(ngModel)]="customStartDate"
                            (dateChange)="onFilterChange()" title="Date de début">
                        <mat-datepicker-toggle matSuffix [for]="sPicker"></mat-datepicker-toggle>
                        <mat-datepicker #sPicker></mat-datepicker>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="density-compact">
                        <mat-label>Au</mat-label>
                        <input matInput [matDatepicker]="ePicker" [(ngModel)]="customEndDate"
                            (dateChange)="onFilterChange()" title="Date de fin">
                        <mat-datepicker-toggle matSuffix [for]="ePicker"></mat-datepicker-toggle>
                        <mat-datepicker #ePicker></mat-datepicker>
                    </mat-form-field>
                </ng-container>
            </ng-container>

            <!-- Search -->
            <mat-form-field appearance="outline" class="density-compact search-field">
                <mat-label>Filtrer par Client / N°</mat-label>
                <input matInput [(ngModel)]="clientSearch" placeholder="Rechercher..."
                    title="Recherche par client ou numéro">
                <mat-icon matPrefix>search</mat-icon>
            </mat-form-field>

            <button mat-icon-button (click)="loadData()" [class.refreshing]="loading" color="primary">
                <mat-icon>refresh</mat-icon>
            </button>
        </div>
    </div>

    <mat-tab-group animationDuration="0ms" class="styled-tabs">
        <!-- Tab 1: BC (Bons de Commande) -->
        <mat-tab>
            <ng-template mat-tab-label>
                <mat-icon>shopping_cart</mat-icon>
                <span>Bons de Commande</span>
                <span class="tab-badge" *ngIf="invoicesWithPayment.length > 0">{{ invoicesWithPayment.length }}</span>
            </ng-template>

            <div class="tab-content">
                <div class="modern-table-container">
                    <table class="premium-table">
                        <thead>
                            <tr>
                                <th>Numéro</th>
                                <th>Client</th>
                                <th>Date Emission</th>
                                <th>Total TTC</th>
                                <th>Payé</th>
                                <th>Reste</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <ng-container *ngFor="let group of groupedWithPayment">
                                <tr class="group-header">
                                    <td colspan="7">
                                        <div class="header-content">
                                            <mat-icon>calendar_month</mat-icon>
                                            {{ group.month }}
                                        </div>
                                    </td>
                                </tr>
                                <tr *ngFor="let invoice of group.invoices" class="data-row">
                                    <td class="font-bold">{{ invoice.numero }}</td>
                                    <td>
                                        <div class="client-cell">
                                            <div class="name">{{ getClientName(invoice) }}</div>
                                            <div class="fiche-ref" *ngIf="invoice.ficheId">Ref: {{
                                                invoice.ficheId.substring(0,8) }}</div>
                                        </div>
                                    </td>
                                    <td>{{ invoice.dateEmission | date:'dd/MM/yyyy' }}</td>
                                    <td class="price-cell">{{ invoice.totalTTC | number:'1.2-2' }}</td>
                                    <td class="price-cell paid">{{ getMontantPaye(invoice) | number:'1.2-2' }}</td>
                                    <td class="price-cell remain">{{ invoice.resteAPayer | number:'1.2-2' }}</td>
                                    <td class="actions-cell">
                                        <div class="action-buttons">
                                            <button mat-icon-button color="primary" (click)="viewDocument(invoice)"
                                                matTooltip="Voir">
                                                <mat-icon>description</mat-icon>
                                            </button>
                                            <button mat-icon-button [matMenuTriggerFor]="menu">
                                                <mat-icon>more_vert</mat-icon>
                                            </button>
                                        </div>
                                        <mat-menu #menu="matMenu">
                                            <button mat-menu-item (click)="openPaymentDialog(invoice)"
                                                *ngIf="invoice.resteAPayer > 0">
                                                <mat-icon color="primary">payments</mat-icon>
                                                <span>Paiement</span>
                                            </button>
                                            <button mat-menu-item (click)="validateInvoice(invoice)">
                                                <mat-icon style="color: #10b981;">check_circle</mat-icon>
                                                <span>Facturer (BC → Facture)</span>
                                            </button>
                                            <button mat-menu-item (click)="viewFiche(invoice)">
                                                <mat-icon>visibility</mat-icon>
                                                <span>Afficher Fiche</span>
                                            </button>
                                            <mat-divider></mat-divider>
                                            <button mat-menu-item (click)="createAvoir(invoice)">
                                                <mat-icon color="warn">assignment_return</mat-icon>
                                                <span>Annuler (Créer Avoir)</span>
                                            </button>
                                        </mat-menu>
                                    </td>
                                </tr>
                                <tr class="group-footer">
                                    <td colspan="3" class="text-right">Total {{ group.month }}:</td>
                                    <td class="price-cell">{{ group.totalTTC | number:'1.2-2' }}</td>
                                    <td class="price-cell">{{ group.totalPaid | number:'1.2-2' }}</td>
                                    <td class="price-cell">{{ group.totalReste | number:'1.2-2' }}</td>
                                    <td></td>
                                </tr>
                            </ng-container>
                        </tbody>
                    </table>
                </div>
            </div>
        </mat-tab>

        <!-- Tab 2: Factures (Validated) -->
        <mat-tab>
            <ng-template mat-tab-label>
                <mat-icon>verified</mat-icon>
                <span>Factures</span>
                <span class="tab-badge ok" *ngIf="invoicesValid.length > 0">{{ invoicesValid.length }}</span>
            </ng-template>

            <div class="tab-content">
                <div class="modern-table-container">
                    <table class="premium-table">
                        <thead>
                            <tr>
                                <th>Numéro</th>
                                <th>Client</th>
                                <th>Date Emission</th>
                                <th>Total TTC</th>
                                <th>Reste</th>
                                <th>Statut</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <ng-container *ngFor="let group of groupedValid">
                                <tr class="group-header">
                                    <td colspan="7">
                                        <div class="header-content">
                                            <mat-icon>calendar_today</mat-icon>
                                            {{ group.month }}
                                        </div>
                                    </td>
                                </tr>
                                <tr *ngFor="let invoice of group.invoices" class="data-row">
                                    <td class="font-bold">{{ invoice.numero }}</td>
                                    <td>{{ getClientName(invoice) }}</td>
                                    <td>{{ invoice.dateEmission | date:'dd/MM/yyyy' }}</td>
                                    <td class="price-cell">{{ invoice.totalTTC | number:'1.2-2' }}</td>
                                    <td class="price-cell">{{ invoice.resteAPayer | number:'1.2-2' }}</td>
                                    <td>
                                        <span class="status-badge" [ngClass]="invoice.statut?.toLowerCase()">
                                            {{ invoice.statut }}
                                        </span>
                                    </td>
                                    <td class="actions-cell">
                                        <div class="action-buttons">
                                            <button mat-icon-button color="primary" (click)="viewDocument(invoice)">
                                                <mat-icon>visibility</mat-icon>
                                            </button>
                                            <button mat-icon-button [matMenuTriggerFor]="mFact">
                                                <mat-icon>more_vert</mat-icon>
                                            </button>
                                        </div>
                                        <mat-menu #mFact="matMenu">
                                            <button mat-menu-item (click)="openPaymentDialog(invoice)"
                                                *ngIf="invoice.resteAPayer > 0">
                                                <mat-icon>payments</mat-icon>
                                                <span>Paiement</span>
                                            </button>
                                            <button mat-menu-item (click)="createAvoir(invoice)">
                                                <mat-icon color="warn">assignment_return</mat-icon>
                                                <span>Échanger / Avoir</span>
                                            </button>
                                        </mat-menu>
                                    </td>
                                </tr>
                            </ng-container>
                        </tbody>
                    </table>
                </div>
            </div>
        </mat-tab>

        <!-- Tab 3: Devis -->
        <mat-tab>
            <ng-template mat-tab-label>
                <mat-icon>inventory_2</mat-icon>
                <span>Devis (Instance)</span>
            </ng-template>
            <div class="tab-content">
                <div class="modern-table-container">
                    <table class="premium-table">
                        <thead>
                            <tr>
                                <th>Numéro</th>
                                <th>Client</th>
                                <th>Date</th>
                                <th>Total TTC</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let invoice of invoicesWithoutPayment" class="data-row">
                                <td>{{ invoice.numero }}</td>
                                <td>{{ getClientName(invoice) }}</td>
                                <td>{{ invoice.dateEmission | date:'dd/MM/yyyy' }}</td>
                                <td class="price-cell">{{ invoice.totalTTC | number:'1.2-2' }}</td>
                                <td class="actions-cell">
                                    <button mat-button color="primary" (click)="validateInvoice(invoice)">
                                        Valider BC
                                    </button>
                                    <button mat-icon-button [matMenuTriggerFor]="mDevis">
                                        <mat-icon>more_vert</mat-icon>
                                    </button>
                                    <mat-menu #mDevis="matMenu">
                                        <button mat-menu-item (click)="viewDocument(invoice)">Voir</button>
                                        <button mat-menu-item (click)="archiveInvoice(invoice)">Archiver</button>
                                    </mat-menu>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </mat-tab>

        <!-- Tab 4: Avoirs -->
        <mat-tab>
            <ng-template mat-tab-label>
                <mat-icon>assignment_return</mat-icon>
                <span>Avoirs</span>
                <span class="tab-badge warn" *ngIf="invoicesAvoir.length > 0">{{ invoicesAvoir.length }}</span>
            </ng-template>
            <div class="tab-content">
                <div class="modern-table-container">
                    <table class="premium-table">
                        <thead>
                            <tr>
                                <th>N° Avoir</th>
                                <th>Facture Origine</th>
                                <th>Client</th>
                                <th>Date</th>
                                <th>Montant</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let invoice of invoicesAvoir" class="data-row">
                                <td class="font-bold text-danger">{{ invoice.numero }}</td>
                                <td>{{ invoice.parentFacture?.numero || '-' }}</td>
                                <td>{{ getClientName(invoice) }}</td>
                                <td>{{ invoice.dateEmission | date:'dd/MM/yyyy' }}</td>
                                <td class="price-cell text-danger">-{{ invoice.totalTTC | number:'1.2-2' }}</td>
                                <td>
                                    <button mat-icon-button (click)="viewDocument(invoice)">
                                        <mat-icon>visibility</mat-icon>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </mat-tab>
    </mat-tab-group>
</div>