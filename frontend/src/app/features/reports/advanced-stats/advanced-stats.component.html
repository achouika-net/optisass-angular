<div class="advanced-stats-container">
    <div class="header">
        <h1>
            <mat-icon>query_stats</mat-icon>
            Statistiques Avancées
        </h1>
        <button mat-raised-button color="primary" (click)="loadData()" [disabled]="loading">
            <mat-icon>refresh</mat-icon>
            Actualiser
        </button>
    </div>

    <!-- Unified Filter Toolbar -->
    <div class="filter-toolbar glass mt-4 mb-6">
        <div class="period-chips">
            <button mat-button class="chip-btn" [class.active]="filterType === 'ALL'"
                (click)="setFilterType('ALL')">Toute la période</button>
            <button mat-button class="chip-btn" [class.active]="filterType === 'DAILY'"
                (click)="setFilterType('DAILY')">Aujourd'hui</button>
            <button mat-button class="chip-btn" [class.active]="filterType === 'MONTHLY'"
                (click)="setFilterType('MONTHLY')">Par Mois</button>
            <button mat-button class="chip-btn" [class.active]="filterType === 'YEARLY'"
                (click)="setFilterType('YEARLY')">Annuel</button>
            <button mat-button class="chip-btn" [class.active]="filterType === 'CUSTOM'"
                (click)="setFilterType('CUSTOM')">Personnalisé</button>
        </div>

        <div class="filter-controls">
            <ng-container [ngSwitch]="filterType">
                <!-- Daily -->
                <mat-form-field appearance="outline" class="density-compact" *ngSwitchCase="'DAILY'">
                    <mat-label>Date</mat-label>
                    <input matInput [matDatepicker]="dPicker" [(ngModel)]="selectedDate" (dateChange)="onFilterChange()"
                        title="Choisir une date" placeholder="JJ/MM/AAAA">
                    <mat-datepicker-toggle matSuffix [for]="dPicker"></mat-datepicker-toggle>
                    <mat-datepicker #dPicker></mat-datepicker>
                </mat-form-field>

                <!-- Monthly -->
                <ng-container *ngSwitchCase="'MONTHLY'">
                    <mat-form-field appearance="outline" class="density-compact month-field">
                        <mat-label>Mois</mat-label>
                        <mat-select [(ngModel)]="selectedMonth" (selectionChange)="onFilterChange()"
                            title="Sélectionner le mois">
                            <mat-option *ngFor="let m of availableMonths" [value]="m.value">{{ m.label }}</mat-option>
                        </mat-select>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="density-compact year-field">
                        <mat-label>Année</mat-label>
                        <mat-select [(ngModel)]="selectedYear" (selectionChange)="onFilterChange()"
                            title="Sélectionner l'année">
                            <mat-option *ngFor="let y of availableYears" [value]="y">{{ y }}</mat-option>
                        </mat-select>
                    </mat-form-field>
                </ng-container>

                <!-- Yearly -->
                <mat-form-field appearance="outline" class="density-compact year-field" *ngSwitchCase="'YEARLY'">
                    <mat-label>Année</mat-label>
                    <mat-select [(ngModel)]="selectedYear" (selectionChange)="onFilterChange()"
                        title="Sélectionner l'année">
                        <mat-option *ngFor="let y of availableYears" [value]="y">{{ y }}</mat-option>
                    </mat-select>
                </mat-form-field>

                <!-- Custom -->
                <ng-container *ngSwitchCase="'CUSTOM'">
                    <mat-form-field appearance="outline" class="density-compact">
                        <mat-label>Du</mat-label>
                        <input matInput [matDatepicker]="sPicker" [(ngModel)]="customStartDate"
                            (dateChange)="onFilterChange()" title="Date de début" placeholder="JJ/MM/AAAA">
                        <mat-datepicker-toggle matSuffix [for]="sPicker"></mat-datepicker-toggle>
                        <mat-datepicker #sPicker></mat-datepicker>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="density-compact">
                        <mat-label>Au</mat-label>
                        <input matInput [matDatepicker]="ePicker" [(ngModel)]="customEndDate"
                            (dateChange)="onFilterChange()" title="Date de fin" placeholder="JJ/MM/AAAA">
                        <mat-datepicker-toggle matSuffix [for]="ePicker"></mat-datepicker-toggle>
                        <mat-datepicker #ePicker></mat-datepicker>
                    </mat-form-field>
                </ng-container>
            </ng-container>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div *ngIf="loading" class="loading-overlay">
        <mat-icon class="spinner">refresh</mat-icon>
        <p>Chargement des statistiques...</p>
    </div>

    <!-- Summary Cards -->
    <div class="summary-cards" *ngIf="summary && !loading">
        <mat-card class="stat-card blue">
            <mat-card-content>
                <div class="stat-icon">
                    <mat-icon>monetization_on</mat-icon>
                </div>
                <div class="stat-info">
                    <p class="stat-label">CA Total</p>
                    <h2 class="stat-value">{{ summary.totalRevenue | number:'1.2-2' }} DH</h2>
                </div>
            </mat-card-content>
        </mat-card>

        <mat-card class="stat-card green">
            <mat-card-content>
                <div class="stat-icon">
                    <mat-icon>inventory_2</mat-icon>
                </div>
                <div class="stat-info">
                    <p class="stat-label">Total Produits</p>
                    <h2 class="stat-value">{{ summary.totalProducts | number }}</h2>
                </div>
            </mat-card-content>
        </mat-card>

        <mat-card class="stat-card orange">
            <mat-card-content>
                <div class="stat-icon">
                    <mat-icon>people</mat-icon>
                </div>
                <div class="stat-info">
                    <p class="stat-label">Total Clients</p>
                    <h2 class="stat-value">{{ summary.totalClients | number }}</h2>
                </div>
            </mat-card-content>
        </mat-card>

        <mat-card class="stat-card purple">
            <mat-card-content>
                <div class="stat-icon">
                    <mat-icon>trending_up</mat-icon>
                </div>
                <div class="stat-info">
                    <p class="stat-label">Taux de Conversion</p>
                    <h2 class="stat-value">{{ summary.conversionRate | number:'1.1-1' }}%</h2>
                </div>
            </mat-card-content>
        </mat-card>

        <mat-card class="stat-card red">
            <mat-card-content>
                <div class="stat-icon">
                    <mat-icon>payments</mat-icon>
                </div>
                <div class="stat-info">
                    <p class="stat-label">Total Dépenses</p>
                    <h2 class="stat-value">{{ summary.totalExpenses | number:'1.2-2' }} DH</h2>
                </div>
            </mat-card-content>
        </mat-card>
    </div>

    <!-- Charts Grid -->
    <div class="charts-grid" *ngIf="!loading">
        <mat-card class="chart-card">
            <mat-card-header>
                <mat-card-title>Évolution du CA</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <div class="chart-container">
                    <canvas #revenueChartCanvas></canvas>
                </div>
            </mat-card-content>
        </mat-card>

        <mat-card class="chart-card">
            <mat-card-header>
                <mat-card-title>Répartition par Type de Produit</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <div class="chart-container">
                    <canvas #productChartCanvas></canvas>
                </div>
            </mat-card-content>
        </mat-card>

        <mat-card class="chart-card">
            <mat-card-header>
                <mat-card-title>Taux de Conversion</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <div class="chart-container">
                    <canvas #conversionChartCanvas></canvas>
                </div>
            </mat-card-content>
        </mat-card>

        <mat-card class="chart-card">
            <mat-card-header>
                <mat-card-title>Stock par Entrepôt</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <div class="chart-container">
                    <canvas #stockChartCanvas></canvas>
                </div>
            </mat-card-content>
        </mat-card>

        <mat-card class="chart-card">
            <mat-card-header>
                <mat-card-title>Top 10 Clients</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <div class="chart-container">
                    <canvas #clientsChartCanvas></canvas>
                </div>
            </mat-card-content>
        </mat-card>

        <mat-card class="chart-card">
            <mat-card-header>
                <mat-card-title>Méthodes de Paiement</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <div class="chart-container">
                    <canvas #paymentsChartCanvas></canvas>
                </div>
            </mat-card-content>
        </mat-card>
    </div>
</div>