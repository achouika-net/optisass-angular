<div class="camera-container">
    <div class="video-wrapper">
        <video #videoElement autoplay playsinline muted class="video-element"></video>
        <canvas #overlayCanvas width="1280" height="720" class="overlay-canvas" (mousedown)="onMouseDown($event)"
            (mousemove)="onMouseMove($event)" (mouseup)="onMouseUp()" (mouseleave)="onMouseUp()">
        </canvas>

        @if (cameraError) {
        <div class="loading-overlay" style="background: rgba(0,0,0,0.85); color: #ff6b6b; z-index: 20;">
            <div style="font-size: 48px; margin-bottom: 20px;">‚ö†Ô∏è</div>
            <p style="text-align:center; max-width: 80%;">{{ cameraError }}</p>
            <button (click)="startCamera()"
                style="margin-top:20px; padding: 10px 20px; background: white; color: black; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                R√©essayer
            </button>
        </div>
        } @else if (!isReady) {
        <div class="loading-overlay">
            <div class="spinner"></div>
            <p>Chargement du syst√®me de d√©tection...</p>
        </div>
        }
    </div>

    <div class="controls-panel">
        <div class="calibration-section">
            <h3>üìè Calibration</h3>

            @if (!isCalibrated) {
            <div class="calibration-instructions">
                <p class="instruction-title">üéØ Calibration Rapide</p>
                <ol class="instruction-list">
                    <li>Portez vos lunettes</li>
                    <li>Regardez la cam√©ra bien en face</li>
                    <li>Entrez la largeur de votre monture (mm)</li>
                    <li>Cliquez "Calibrer"</li>
                </ol>
            </div>

            <div class="input-group">
                <label for="frameWidth">Largeur monture (mm)</label>
                <input type="number" id="frameWidth" [(ngModel)]="frameWidthMm" placeholder="ex: 140"
                    class="form-control" />
                <small class="help-text">Largeur totale de la monture (g√©n√©ralement 130-150mm)</small>
            </div>

            <button (click)="calibrateWithFrame()" [disabled]="!frameWidthMm || frameWidthMm <= 0"
                class="btn-calibrate">
                ‚úì Calibrer avec Monture
            </button>
            } @else {
            <div class="calibration-status success">
                ‚úì Calibr√©: {{ pixelsPerMm?.toFixed(2) }} px/mm
                <button (click)="resetCalibration()" class="btn-reset">üîÑ Recalibrer</button>
            </div>
            }
        </div>

        <div class="measurements-section">
            <h3>üìä Mesures</h3>
            @if (latestMeasurement) {
            <div class="measurement-item">
                <span class="label">PD Total:</span>
                <span class="value">{{ latestMeasurement.pdMm.toFixed(1) }} mm</span>
            </div>
            <div class="measurement-item">
                <span class="label">PD Gauche:</span>
                <span class="value">{{ latestMeasurement.pdLeftMm.toFixed(1) }} mm</span>
            </div>
            <div class="measurement-item">
                <span class="label">PD Droit:</span>
                <span class="value">{{ latestMeasurement.pdRightMm.toFixed(1) }} mm</span>
            </div>
            @if (latestMeasurement.frameHeightMm) {
            <div class="measurement-item" style="border-top: 2px solid #f1f5f9; margin-top: 5px; padding-top: 10px;">
                <span class="label" style="color: #FF0000; font-weight: bold;">Hauteur Verre:</span>
                <span class="value" style="color: #FF0000;">{{ latestMeasurement.frameHeightMm.toFixed(1) }} mm</span>
            </div>
            }
            } @else {
            <p class="no-data">Aucune mesure disponible</p>
            }
            @if (latestMeasurement?.edMm) {
            <div class="measurement-item" style="border-top: 1px dashed #cbd5e1; margin-top: 8px; padding-top: 8px;">
                <span class="label">Diam√®tre Utile (Calc):</span>
                <span class="value">{{ latestMeasurement!.edMm.toFixed(1) }} mm</span>
            </div>
            }
            @if (latestMeasurement?.standardDiameterMm) {
            <div class="recommendation-banner-mini"
                style="background: #f0f4ff; border: 1px solid #dbeafe; border-radius: 8px; padding: 10px; margin-top: 10px; font-size: 13px; color: #1e40af;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-weight: bold;">‚ìò</span>
                    <div>
                        Diam√®tre utile: <strong>{{ latestMeasurement!.edMm.toFixed(1) }} mm</strong>.
                        Marge (+2mm): <strong>{{ (latestMeasurement!.edMm + 2).toFixed(1) }} mm</strong>.
                        Commande: <strong>√ò {{ latestMeasurement!.standardDiameterMm }} mm</strong>
                    </div>
                </div>
            </div>
            }
        </div>
    </div>
</div>