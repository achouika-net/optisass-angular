<div class="container">
    <div class="header">
        <h1>Demandes d'Alimentation</h1>
        <button mat-stroked-button color="primary" (click)="loadRequests()">
            <mat-icon>refresh</mat-icon> Actualiser
        </button>
    </div>

    <mat-card>
        <table mat-table [dataSource]="requests" class="mat-elevation-z0">
            <ng-container matColumnDef="date">
                <th mat-header-cell *matHeaderCellDef>Date</th>
                <td mat-cell *matCellDef="let req">{{ req.createdAt | date: 'dd/MM/yyyy HH:mm' }}</td>
            </ng-container>

            <ng-container matColumnDef="caisse">
                <th mat-header-cell *matHeaderCellDef>Caisse Dépenses</th>
                <td mat-cell *matCellDef="let req">{{ req.journeeCaisse?.caisse?.nom }}</td>
            </ng-container>

            <ng-container matColumnDef="categorie">
                <th mat-header-cell *matHeaderCellDef>Libellé / Description</th>
                <td mat-cell *matCellDef="let req">
                    <div class="libelle-container">
                        <span class="libelle-main">{{ req.depense ? req.depense.categorie : 'Remboursement Client'
                            }}</span>
                        <span class="libelle-sub text-muted">
                            {{ req.depense ? req.depense.description : 'Facture: ' + (req.paiement?.facture?.numero ||
                            'N/A') }}
                        </span>
                    </div>
                </td>
            </ng-container>

            <ng-container matColumnDef="montant">
                <th mat-header-cell *matHeaderCellDef class="text-right">Montant</th>
                <td mat-cell *matCellDef="let req" class="montant-cell">{{ req.montant | number:'1.0-2' }} DH</td>
            </ng-container>

            <ng-container matColumnDef="statut">
                <th mat-header-cell *matHeaderCellDef>Statut</th>
                <td mat-cell *matCellDef="let req">
                    <mat-chip [class]="getStatusClass(req.statut)" disabled>
                        {{ req.statut === 'EN_ATTENTE' ? 'En attente' : req.statut === 'VALIDEE' ? 'Validée' : 'Rejetée'
                        }}
                    </mat-chip>
                </td>
            </ng-container>

            <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef class="text-right">Actions</th>
                <td mat-cell *matCellDef="let req" class="actions">
                    <ng-container *ngIf="req.statut === 'EN_ATTENTE'">
                        <button mat-flat-button color="primary" (click)="approve(req)" matTooltip="Approuver">
                            <mat-icon>check_circle</mat-icon> Valider
                        </button>
                        <button mat-icon-button color="warn" (click)="reject(req)" matTooltip="Rejeter">
                            <mat-icon>cancel</mat-icon>
                        </button>
                    </ng-container>
                    <div *ngIf="req.statut !== 'EN_ATTENTE'" class="validation-date">
                        <span class="date-label">Validé le</span>
                        <span class="date-value">{{ req.validatedAt | date: 'dd/MM/yyyy HH:mm' }}</span>
                    </div>
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

            <tr class="mat-row" *matNoDataRow>
                <td class="mat-cell" colspan="6" style="text-align: center; padding: 40px;">
                    <mat-icon style="font-size: 48px; width: 48px; height: 48px; color: #ccc;">info</mat-icon>
                    <p>Aucune demande d'alimentation trouvée.</p>
                </td>
            </tr>
        </table>
    </mat-card>
</div>