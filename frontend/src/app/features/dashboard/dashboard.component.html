<div class="dashboard-wrapper">
    <!-- Header -->
    <div class="dashboard-header">
        <div class="title-section">
            <h1>Tableau de Bord Exécutif</h1>
            <p class="subtitle">Aperçu global des performances de votre centre</p>
        </div>
        <div class="actions-section">
            <button mat-flat-button color="primary" (click)="loadAllData()" [disabled]="loading">
                <mat-icon [class.rotating]="loading">refresh</mat-icon>
                Actualiser
            </button>
        </div>
    </div>

    <!-- Unified Filter Toolbar -->
    <div class="filter-toolbar glass">
        <div class="period-chips">
            <button mat-button class="chip-btn" [class.active]="filterType === 'ALL'"
                (click)="setFilterType('ALL')">Toute la période</button>
            <button mat-button class="chip-btn" [class.active]="filterType === 'DAILY'"
                (click)="setFilterType('DAILY')">Aujourd'hui</button>
            <button mat-button class="chip-btn" [class.active]="filterType === 'MONTHLY'"
                (click)="setFilterType('MONTHLY')">Par Mois</button>
            <button mat-button class="chip-btn" [class.active]="filterType === 'YEARLY'"
                (click)="setFilterType('YEARLY')">Annuel</button>
            <button mat-button class="chip-btn" [class.active]="filterType === 'CUSTOM'"
                (click)="setFilterType('CUSTOM')">Personnalisé</button>
        </div>

        <div class="filter-controls">
            <ng-container [ngSwitch]="filterType">
                <!-- Daily -->
                <mat-form-field appearance="outline" class="density-compact" *ngSwitchCase="'DAILY'">
                    <mat-label>Date</mat-label>
                    <input matInput [matDatepicker]="dPicker" [(ngModel)]="selectedDate" (dateChange)="onFilterChange()"
                        title="Choisir une date" placeholder="JJ/MM/AAAA">
                    <mat-datepicker-toggle matSuffix [for]="dPicker"></mat-datepicker-toggle>
                    <mat-datepicker #dPicker></mat-datepicker>
                </mat-form-field>

                <!-- Monthly -->
                <ng-container *ngSwitchCase="'MONTHLY'">
                    <mat-form-field appearance="outline" class="density-compact month-field">
                        <mat-label>Mois</mat-label>
                        <mat-select [(ngModel)]="selectedMonth" (selectionChange)="onFilterChange()"
                            title="Sélectionner le mois">
                            <mat-option *ngFor="let m of availableMonths" [value]="m.value">{{ m.label }}</mat-option>
                        </mat-select>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="density-compact year-field">
                        <mat-label>Année</mat-label>
                        <mat-select [(ngModel)]="selectedYear" (selectionChange)="onFilterChange()"
                            title="Sélectionner l'année">
                            <mat-option *ngFor="let y of availableYears" [value]="y">{{ y }}</mat-option>
                        </mat-select>
                    </mat-form-field>
                </ng-container>

                <!-- Yearly -->
                <mat-form-field appearance="outline" class="density-compact year-field" *ngSwitchCase="'YEARLY'">
                    <mat-label>Année</mat-label>
                    <mat-select [(ngModel)]="selectedYear" (selectionChange)="onFilterChange()"
                        title="Sélectionner l'année">
                        <mat-option *ngFor="let y of availableYears" [value]="y">{{ y }}</mat-option>
                    </mat-select>
                </mat-form-field>

                <!-- Custom -->
                <ng-container *ngSwitchCase="'CUSTOM'">
                    <mat-form-field appearance="outline" class="density-compact">
                        <mat-label>Du</mat-label>
                        <input matInput [matDatepicker]="sPicker" [(ngModel)]="customStartDate"
                            (dateChange)="onFilterChange()" title="Date de début" placeholder="JJ/MM/AAAA">
                        <mat-datepicker-toggle matSuffix [for]="sPicker"></mat-datepicker-toggle>
                        <mat-datepicker #sPicker></mat-datepicker>
                    </mat-form-field>
                    <mat-form-field appearance="outline" class="density-compact">
                        <mat-label>Au</mat-label>
                        <input matInput [matDatepicker]="ePicker" [(ngModel)]="customEndDate"
                            (dateChange)="onFilterChange()" title="Date de fin" placeholder="JJ/MM/AAAA">
                        <mat-datepicker-toggle matSuffix [for]="ePicker"></mat-datepicker-toggle>
                        <mat-datepicker #ePicker></mat-datepicker>
                    </mat-form-field>
                </ng-container>
            </ng-container>
        </div>
    </div>

    <!-- KPI Row -->
    <div class="kpi-grid">
        <mat-card class="kpi-card glass primary">
            <div class="kpi-icon">
                <mat-icon>payments</mat-icon>
            </div>
            <div class="kpi-content">
                <span class="label">Chiffre d'Affaires</span>
                <h2 class="value">{{ (summary?.totalRevenue || 0) | number:'1.2-2' }} DH</h2>
            </div>
        </mat-card>

        <mat-card class="kpi-card glass success">
            <div class="kpi-icon">
                <mat-icon>group</mat-icon>
            </div>
            <div class="kpi-content">
                <span class="label">Total Clients</span>
                <h2 class="value">{{ (summary?.totalClients || 0) | number }}</h2>
                <div class="fiches-breakdown" *ngIf="summary?.fichesStats">
                    <div class="fiche-mini-stat" matTooltip="Montures (Optique/Solaire)">
                        <mat-icon>eyeglasses</mat-icon>
                        <span class="stat-label">M: </span>
                        <span>{{ summary?.fichesStats?.monture || 0 }}</span>
                    </div>
                    <div class="fiche-mini-stat" matTooltip="Lentilles de contact">
                        <mat-icon>remove_red_eye</mat-icon>
                        <span class="stat-label">L: </span>
                        <span>{{ summary?.fichesStats?.lentilles || 0 }}</span>
                    </div>
                    <div class="fiche-mini-stat" matTooltip="Produits & Accessoires">
                        <mat-icon>inventory_2</mat-icon>
                        <span class="stat-label">P: </span>
                        <span>{{ summary?.fichesStats?.produit || 0 }}</span>
                    </div>
                </div>
            </div>
        </mat-card>

        <mat-card class="kpi-card glass danger">
            <div class="kpi-icon">
                <mat-icon>account_balance_wallet</mat-icon>
            </div>
            <div class="kpi-content">
                <span class="label">Dépenses Globales</span>
                <h2 class="value">{{ (summary?.totalExpenses || 0) | number:'1.2-2' }} DH</h2>
            </div>
        </mat-card>

        <mat-card class="kpi-card glass accent">
            <div class="kpi-icon">
                <mat-icon>ads_click</mat-icon>
            </div>
            <div class="kpi-content">
                <span class="label">Taux de Conversion</span>
                <h2 class="value">{{ (summary?.conversionRate || 0) | number:'1.1-1' }}%</h2>
            </div>
        </mat-card>
    </div>

    <!-- Main Charts Row -->
    <div class="main-grid">
        <mat-card class="chart-card glass lg">
            <mat-card-header>
                <mat-card-title>Performance Financière</mat-card-title>
                <mat-card-subtitle>Revenus mensuels consolidés</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
                <div class="chart-container">
                    <canvas #revenueChart></canvas>
                </div>
            </mat-card-content>
        </mat-card>

        <mat-card class="chart-card glass sm">
            <mat-card-header>
                <mat-card-title>Modes de Paiement</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <div class="chart-container donut">
                    <canvas #paymentChart></canvas>
                </div>
            </mat-card-content>
        </mat-card>
    </div>

    <!-- Bottom Row -->
    <div class="secondary-grid">
        <mat-card class="chart-card glass">
            <mat-card-header>
                <mat-card-title>Inventaire par Type</mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <div class="chart-container">
                    <canvas #distributionChart></canvas>
                </div>
            </mat-card-content>
        </mat-card>

        <mat-card class="list-card glass">
            <mat-card-header>
                <mat-card-title>Top 5 Clients</mat-card-title>
                <mat-card-subtitle>Par volume d'achat</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
                <div class="client-list">
                    <div class="client-item" *ngFor="let client of topClients">
                        <div class="client-avatar">
                            {{ client.clientName.charAt(0) }}
                        </div>
                        <div class="client-info">
                            <span class="name">{{ client.clientName }}</span>
                            <span class="meta">{{ client.invoiceCount }} factures</span>
                        </div>
                        <div class="client-value">
                            {{ client.totalRevenue | number:'1.0-0' }} DH
                        </div>
                    </div>
                    <div *ngIf="topClients.length === 0" class="no-data">
                        Aucune donnée client disponible
                    </div>
                </div>
            </mat-card-content>
        </mat-card>
    </div>
</div>